// LICENSE: MIT, copyright Adrian Kalbarczyk 2010-1016
(function(a){a.extend({onAvailable:function(b,c,e,d,g){if("function"!==typeof c)throw new TypeError;var h=a.onAvailable;b instanceof Array||(b=[b]);for(var m=0,n=b.length;m<n;++m)h.listeners.push({id:b[m],callback:c,obj:e,override:d,checkContent:!!g});h.interval||(h.interval=window.setInterval(h.checkAvailable,h.POLL_INTERVAL));return this},onContentReady:function(b,c,e,d){a.onAvailable(b,c,e,d,!0)}});a.extend(a.onAvailable,{POLL_RETRIES:2E3,POLL_INTERVAL:20,interval:null,listeners:[],executeCallback:function(a,
c){var e=a;c.override&&(e=!0===c.override?c.obj:c.override);c.callback.call(e,c.obj)},checkAvailable:function(){for(var b=a.onAvailable,c=b.listeners,e=0;e<c.length;++e){var d=c[e],g=$(d.id);g[0]&&(!d.checkContent||d.checkContent&&(g.nextSibling||g.parentNode.nextSibling||a.isReady))&&(b.executeCallback(g,d),c.splice(e,1),--e);if(0===c.length||0===--b.POLL_RETRIES)b.interval=window.clearInterval(b.interval)}}})})(jQuery);
(function(a){a.extend({uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=16*Math.random()|0;return("x"===a?c:c&3|8).toString(16)}).toUpperCase()}})})(jQuery);var API=function(a,b){this.init(a,b||{})};
API.prototype={D:!1,init:function(a,b){this.D=b.D||b.debug;this.cache=a||{}},call:function(a,b,c){var e=this;a=this.fixURL(ac.replaceVars(a));var d=this.pathFromURL(a),g={url:a,success:function(a){d?set(e.cache,d.slice(1),a):$.extend(e.cache,a,!0);c(null,a)},error:function(b){return c({status:"error",error:"BackendNotResponding",message:"API call to "+a+" was not successful!"})},dataType:"json"};b&&(g.type="POST",g.data=b);$.ajax(g)},pathFromURL:function(a){a=a.slice(4,a.length-1).replace(/\//g,".");
".default"===a&&(a="");return a},fixURL:function(a){"/"!==a.slice(-1)&&-1===a.indexOf("?")&&(a+="/");"/"!==a[0]&&(a="/"+a);"/api"!==a.slice(0,4)&&(a="/api"+a);return a}};var Fragments=function(a,b){this.init(a,b||{})};
Fragments.prototype={D:!1,init:function(a,b){this.D=b.D||b.debug||this.D;this.cache=a||{}},get:function(a,b){var c=this;a=this.fixURL(ac.replaceVars(a));if(this.cache[a])return b(null,this.cache[a]);$.ajax({url:a,success:function(e){c.cache[a]=e;b(null,e)},error:function(a){b({status:"error",message:"Fragment file at /fragments/"+fragmentURL+" not found!"})},dataType:"html"})},fixURL:function(a){".html"!==a.slice(-5)&&(a+=".html");"/"!==a[0]&&(a="/"+a);"/fragments"!==a.slice(0,10)&&(a="/fragments"+
a);return a}};var AC=function(a){this.init(a||{})};
AC.prototype={D:!1,trim:function(a){return a.slice(0,100)+"..."},PREFIX:"ac",components:{},triggers:[],defaultTemplates:{},RE_PATH_Mustashes:/{{.+?}}/g,RE_PATH_Mustashes_split:/{{.+?}}/g,init:function(a){this.appData={};this.appDataOP=new ObjectPath(this.appData);this.D=a.D||a.debug;this.fragments=new Fragments(null,{D:this.D});this.API=new API(this.appData,{D:this.D})},checkCondition:function(a){a=this.rmMustashes($(a).attr(this.PREFIX+"-condition"));return ret=!a||this.appDataOP.execute(a)},checkShowWhen:function(a){a=
this.rmMustashes($(a).attr(this.PREFIX+"-showWhen"));return ret=!a||this.appDataOP.execute(a)},getNodesWithShowWhen:function(a){var b=this;if(!a.length)return $([]);var c=[];a.each(function(a,d){3!==d.nodeType&&($(d).attr(b.PREFIX+"-showWhen")&&c.push(d),c.push.apply(c,$("*["+b.PREFIX+"-showWhen]",d)))});return $(c)},rmMustashes:function(a){return a?"{{"===a.slice(0,2)?path.slice(2,-3):a:a},onAvailable:function(a,b){this.triggers.push({selector:a,fn:b});$.onAvailable(a,b)},trigger:function(){$.each(this.triggers,
function(){$.onAvailable(this.selector,this.fn)})},replaceVars:function(a){a=a.replace(/\x3c!--[\s\S]*?--\x3e/g,"");var b=a.match(this.RE_PATH_Mustashes);if(!b)return a.replace(/\/{/g,"{");a=a.split(this.RE_PATH_Mustashes_split);var c=[],e=this;$.each(a,function(a,g){var h=b.length?e.appDataOP.execute(b.shift().replace(/ = ""/g,"").slice(2,-2)):"".replace();h instanceof Object&&(h=JSON.stringify(h,null,2));c.push(g,h)});return c.join("").replace(/\/{/g,"{")}};var Spinner=function(a){this.init(a)};
Spinner.prototype={init:function(a){this.el=a;a.spinner=this;this.add()},add:function(){this.el.attr("title","Waiting for response");this.el.find(".ac-spin").remove();this.el.append(" <i class='fa fa-spinner fa-spin ac-spin'></i>")},success:function(){this.el.removeAttr("title");var a=this.el.find(".fa-spin");a.removeClass("fa-spinner fa-spin").addClass("fa-smile-o").addClass("hide-delay");setTimeout(function(){a.remove()},1200);this.destroy()},error:function(a){this.el.attr("title","Error! "+a);
this.el.find(".fa-spin").removeClass("fa-spinner fa-spin").addClass("fa-frown-o")},destroy:function(){delete this.el.spinner;this.el=null}};var hashWorker=function(){this.params=[];this.get();this.hashChangeSource="window";this.currentHash=window.location.hash.substring(2)};
hashWorker.prototype={get:function(){var a=[],b,c=/\+/g,e=/([^|;=]+)=?([^|;]*)/g,d=window.location.hash.substring(2);for(this.currentHash=d;b=e.exec(d);){var g=decodeURIComponent(b[1].replace(c," "));b=decodeURIComponent(b[2].replace(c," "));if(-1===g.indexOf("_ds")){var h={name:g};h[g]=b;a.push(h)}else this.find(g,a)[g]=b}return this.params=a},find:function(a,b){var c=a.indexOf("_ds");-1<c&&(a=a.slice(0,c));return(b||this.params).find(function(b){return b.name===a})},makeHash:function(){var a=[];
$.each(this.params,function(b,c){$.each(c,function(b,c){"name"!=b&&b&&c&&a.push(b+"="+c)})});return"#!"+a.join("|")},remove:function(a){delete a;window.location.hash=this.makeHash()},clean:function(){this.params=Array.filter(this.params,function(a){return $("#"+a.name).length?!0:!1})},update:function(a){var b=this;$.each(a,function(a,e){var d=b.find(a);d?d[a]=e:(d={name:a},d[a]=e,b.params.push(d))});this.clean();window.location.hash=this.makeHash()}};
var set=function(a,b,c){b=b.split(".");for(var e=0;e<b.length-1;e++){var d=b[e];a[d]=a[d]||{};a=a[d]}a[b.pop()]=c},locationHash=new hashWorker;
$(document).ready(function(){$("html").attr("lang");var a=DEBUG=$("html[debug]")?!0:!1,b=new AC({D:a}),c=b.PREFIX,e=$.uuid,d=function(){};window.ac=b;a&&$.ajaxSetup({cache:!1});var g=function(a){var b=[];$("*["+c+"-dataPath]",a).each(function(a,f){0===$(f).parents("*["+c+"-dataPath]").length&&b.push(f)});return $(b)},h=function(){var a=$.uuid();$("body").append("<div id='ac-"+a+"' class='hidden ac-renderHelper'></div>");return $("#ac-"+a)[0]},m=function(a,c,l){l=l||d;var f=h();f.innerHTML=a;p(f,function(){var a=
g(f);a.length&&a.each(q);f.innerHTML=b.replaceVars($(f).html());a=b.getNodesWithShowWhen($(f));$(a).each(function(a,c){b.checkShowWhen(c)||$(this).remove()});b.trigger();a=$(f).html();f.remove();return l(a)})},n=function(a,k){k=k||d;var l=$(a).attr(c+"-dataSource"),f=$(a).attr(c+"-fragment");void 0!==f&&b.fragments.get(f,function(f,d){if(f)return k(f);l?b.API.call(l,$(a).attr(c+"-post"),function(c,f){b.appDataOP.setContext(f);b.appDataOP.setCurrent(f);m(d,f,function(b){a.innerHTML=b;k()})}):m(d,null,
function(b){a.innerHTML=b;return k()})})};AC.loadFragment=n;var p=function(a,k){k=k||d;var l=$("*["+c+"-fragment]",a);if(0===l.length)return k();var f=l.length,e=function(a){0===--f&&k(a)};l.each(function(a,c){if(b.checkCondition(c))n(c,e);else return e()})},u=function(a){var b=g($("*["+c+"-dataPath]",a)),l={};b.replaceWith(function(a,c){var d=e();l[d]=b[a];return"$$"+d+"$$"});return l},q=function(a,k){var l=u(k),f=b.appDataOP.execute(b.rmMustashes($(k).attr(c+"-dataPath"))),d=k.innerHTML.replace(/ ac-dataPath=".*"/ig,
"").trim(),e=b.appDataOP.current;k.innerHTML="";f&&f.forEach(function(a){b.appDataOP.setCurrent(a);a=$($.parseHTML(b.replaceVars("<temp>"+d+"</temp>").replace(/\$\$(.*)\$\$/,function(a){return l[a.slice(2,-2)]})));var f=b.getNodesWithShowWhen(a);f.length&&f.each(function(a,f){b.checkShowWhen(f)?$(this).removeAttr(c+"-showWhen"):$(this).remove()});f=g(a);f.length&&f.each(q);$(k).append(a.children())});$(k).removeAttr(c+"-dataPath");b.appDataOP.setCurrent(e)},t=function(){var a=jQuery.Event("beforehashchange");
$(document).trigger(a);if(!a.isDefaultPrevented()){var b=locationHash.get(),d=function(a){$("#"+a.name).attr(c+"-fragment",a[a.name]).attr(c+"-dataSource",a[a.name+"_ds"]);var e=$("#"+a.name).parents(".modal");("127.0.0.1"===window.location.hostname||"localhost"===window.location.hostname||e&&$(e).is(":visible"))&&e.modal();n($("#"+a.name)[0],function(){b.length&&d(b.shift())})};b.length&&d(b.shift())}};window.onhashchange=function(){locationHash.hashChangeSource||(t(),b.trigger());locationHash.hashChangeSource=
null};window.onload=function(){p($("body"),function(){t()})};$("body").on("click","a,  button",function(a){locationHash.hashChangeSource="internal";var d=$(a.currentTarget);if(d.attr(c+"-target")){var e=d.attr("href");if(e&&"#"===e[0])a.preventDefault();else if(a.preventDefault(),a=jQuery.Event("beforehashchange"),$(document).trigger(a),!a.isDefaultPrevented()){var f=d.attr(c+"-target"),e=d.attr("href");$(f).attr(c+"-fragment");d.parents(".nav").find("*[ac-target="+f+"].active").removeClass("active");
d.addClass("active");new Spinner(d);if(b.checkCondition(d)){"/"===e[0]&&(e=e.slice(1));var g=$(f);g[0]&&(g.attr(c+"-fragment",e),g.attr(c+"-dataSource",d.attr(c+"-dataSource")||""),n(g[0],function(a){if(a)d.spinner.error("ERROR: "+lf.message);else if(b.trigger(),d.spinner.success(),a=d.attr(c+"-redirect"))window.location=a;else{a=f.slice(1);var h={};h[a]=e;var r=g.attr(c+"-dataSource");r&&(h[a+"_ds"]=r);locationHash.update(h)}}))}}}});$.onAvailable("form",function(){this.attr("method","POST");this.attr("enctype",
"multipart/form-data")});$("body").on("submit","form",function(a){a.preventDefault();var d=jQuery.Event("beforehashchange");$(document).trigger(d);if(!d.isDefaultPrevented()){locationHash.hashChangeSource="internal";var e=$(this),f=e.attr(c+"-target"),g=e.attr("href");$(f).attr(c+"-fragment");var d=b.rmMustashes(e.attr(c+"-condition")),h=$(a.originalEvent.explicitOriginalTarget);h[0]||(h=e.find("[type=submit]"));new Spinner(h);if(!f)$.ajax({url:b.API.fixURL(e.attr("action")),data:e.serialize(),success:function(a){var b=
!1,d;for(d in a)if("error"===a[d]["@status"]){b=a[d].message||a[d].error;(a=h.parents("form").find(".ac-error."+a[d].error))&&a.addClass("show");break}if(b)h.spinner.error(b);else if(h.spinner.success(),b=e.attr(c+"-redirect"))window.location=b},error:function(a,b,c){try{h.spinner.error(a.responseJSON.GlobalError.message)}catch(d){h.spinner.error(c||"Server not responding.")}},type:"POST"});else if(!d||b.appDataOP.execute(d)){"/"===g[0]&&(g=g.slice(1));var m=$(f);m[0]&&(m.attr(c+"-fragment",g),(a=
e.attr(c+"-dataSource"))?m.attr(c+"-dataSource",a):m.attr(c+"-dataSource",null),$.ajax({url:b.API.fixURL(e.attr("action")),data:e.serialize(),success:function(a){var d=!1;if("error"===a.status){var d=a.message||a.error,k=h.parents("form").find(".ac-error."+a.error);k&&(k.addClass("show"),k.parent("div").addClass("has-error"))}d?h.spinner.error(d):(h.spinner.success(),(d=e.attr(c+"-redirect"))?window.location=d:(b.appDataOP.setContext(a),n(m[0],function(a){b.trigger();a=f.slice(1);var d={};d[a]=g;
d[a+"_ds"]=e.attr(c+"-dataSource");locationHash.update(d)})))},error:function(a,b,c){try{h.spinner.error(a.responseJSON.GlobalError.message)}catch(d){h.spinner.error(c||"Server not responding.")}},type:"POST"}))}}})});
