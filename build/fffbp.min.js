// LICENSE: MIT, copyright Adrian Kalbarczyk 2010-1016
(function(a){a.extend({onAvailable:function(c,b,d,e,h){if("function"!==typeof b)throw new TypeError;var k=a.onAvailable;c instanceof Array||(c=[c]);for(var n=0,q=c.length;n<q;++n)k.listeners.push({id:c[n],callback:b,obj:d,override:e,checkContent:!!h});k.interval||(k.interval=window.setInterval(k.checkAvailable,k.POLL_INTERVAL));return this},onContentReady:function(c,b,d,e){a.onAvailable(c,b,d,e,!0)}});a.extend(a.onAvailable,{POLL_RETRIES:2E3,POLL_INTERVAL:20,interval:null,listeners:[],executeCallback:function(a,
b){var d=a;b.override&&(d=!0===b.override?b.obj:b.override);b.callback.call(d,b.obj)},checkAvailable:function(){for(var c=a.onAvailable,b=c.listeners,d=0;d<b.length;++d){var e=b[d],h=$(e.id);h[0]&&(!e.checkContent||e.checkContent&&(h.nextSibling||h.parentNode.nextSibling||a.isReady))&&(c.executeCallback(h,e),b.splice(d,1),--d);if(0===b.length||0===--c.POLL_RETRIES)c.interval=window.clearInterval(c.interval)}}})})(jQuery);
(function(a){a.extend({uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"===a?b:b&3|8).toString(16)}).toUpperCase()}})})(jQuery);var API=function(a,c){this.init(a,c||{})};
API.prototype={D:!1,init:function(a,c){this.D=c.D||c.debug;this.cache=a||{}},call:function(a,c,b){var d=this;a=this.fixURL(ac.replaceVars(a));var e=this.pathFromURL(a),h={url:a,success:function(a){e?set(d.cache,e.slice(1),a):$.extend(d.cache,a,!0);b(null,a)},error:function(c){return b({status:"error",error:"BackendNotResponding",message:"API call to "+a+" was not successful!"})},dataType:"json"};c&&(h.type="POST",h.data=c);$.ajax(h)},pathFromURL:function(a){a=a.slice(4,a.length-1).replace(/\//g,".");
".default"===a&&(a="");return a},fixURL:function(a){"/"!==a.slice(-1)&&-1===a.indexOf("?")&&(a+="/");"/"!==a[0]&&(a="/"+a);"/api"!==a.slice(0,4)&&(a="/api"+a);return a}};var Fragments=function(a,c){this.init(a,c||{})};
Fragments.prototype={D:!1,init:function(a,c){this.D=c.D||c.debug;this.cache=a||{}},get:function(a,c){var b=this;a=this.fixURL(ac.replaceVars(a));if(this.cache[a])return c(null,this.cache[a]);$.ajax({url:a,success:function(d){b.cache[a]=d;c(null,d)},error:function(a){c({status:"error",message:"Fragment file at /fragments/"+fragmentURL+" not found!"})},dataType:"html"})},fixURL:function(a){".html"!==a.slice(-5)&&(a+=".html");"/"!==a[0]&&(a="/"+a);"/fragments"!==a.slice(0,10)&&(a="/fragments"+a);return a}};
var AC=function(a){this.init(a||{})};
AC.prototype={D:!1,trim:function(a){return a.slice(0,100)+"..."},PREFIX:"ac",components:{},triggers:[],defaultTemplates:{},RE_PATH_Mustashes:/{{.+?}}/g,RE_PATH_Mustashes_split:/{{.+?}}/g,init:function(a){this.appData={};this.appDataOP=new ObjectPath(this.appData);this.D=a.D||a.debug;this.fragments=new Fragments(null,{D:this.D});this.API=new API(this.appData,{D:this.D})},checkCondition:function(a){a=this.rmMustashes($(a).attr(this.PREFIX+"-condition"));return!a||this.appDataOP.execute(a)},checkShowWhen:function(a){a=
this.rmMustashes($(a).attr(this.PREFIX+"-showWhen"));return ret=!a||this.appDataOP.execute(a)},getNodesWithShowWhen:function(a){var c=this;if(!a.length)return $([]);var b=[];a.each(function(a,e){3!==e.nodeType&&($(e).attr(c.PREFIX+"-showWhen")&&b.push(e),b.push.apply(b,$("*["+c.PREFIX+"-showWhen]",e)))});return $(b)},rmMustashes:function(a){return a?"{{"===a.slice(0,2)?path.slice(2,-3):a:a},onAvailable:function(a,c){this.triggers.push({selector:a,fn:c});$.onAvailable(a,c)},trigger:function(){$.each(this.triggers,
function(){$.onAvailable(this.selector,this.fn)})},replaceVars:function(a){a=a.replace(/\x3c!--[\s\S]*?--\x3e/g,"");var c=a.match(this.RE_PATH_Mustashes);if(!c)return a.replace(/\/{/g,"{");a=a.split(this.RE_PATH_Mustashes_split);var b=[],d=this;$.each(a,function(a,h){var k=c.length?d.appDataOP.execute(c.shift().replace(/ = ""/g,"").slice(2,-2)):"".replace();k instanceof Object&&(k=JSON.stringify(k,null,2));b.push(h,k)});return b.join("").replace(/\/{/g,"{")}};var Spinner=function(a){this.init(a)};
Spinner.prototype={init:function(a){this.el=a;a.spinner=this;this.add()},add:function(){this.el.attr("title","Waiting for response");this.el.find(".ac-spin").remove();this.el.append(" <i class='fa fa-spinner fa-spin ac-spin'></i>")},success:function(){this.el.removeAttr("title");var a=this.el.find(".fa-spin");a.removeClass("fa-spinner fa-spin").addClass("fa-smile-o").addClass("hide-delay");setTimeout(function(){a.remove()},1200);this.destroy()},error:function(a){this.el.attr("title","Error! "+a);
this.el.find(".fa-spin").removeClass("fa-spinner fa-spin").addClass("fa-frown-o")},destroy:function(){delete this.el.spinner;this.el=null}};var hashWorker=function(){this.params={};this.get();this.hashChangeSource="window";this.currentHash=window.location.hash.substring(2)};
hashWorker.prototype={get:function(){var a={},c,b=/\+/g,d=/([^|;=]+)=?([^|;]*)/g,e=window.location.hash.substring(2);for(this.currentHash=e;c=d.exec(e);)a[decodeURIComponent(c[1].replace(b," "))]=decodeURIComponent(c[2].replace(b," "));return this.params=a},makeHash:function(){var a=[];$.each(this.params,function(c,b){c&&b&&a.push(c+"="+b)});return"#!"+a.join("|")},update:function(a){var c=this;$.each(a,function(a,d){c.params[a]=d});window.location.hash=this.makeHash()}};
var set=function(a,c,b){c=c.split(".");for(var d=0;d<c.length-1;d++){var e=c[d];a[e]=a[e]||{};a=a[e]}a[c.pop()]=b},locationHash=new hashWorker;
$(document).ready(function(){$("html").attr("lang");var a=new AC({D:!0}),c=a.PREFIX;DEBUG=!0;var b=$.uuid,d=function(){};window.ac=a;var e=function(a){var f=[];$("*["+c+"-dataPath]",a).each(function(a,b){0===$(b).parents("*["+c+"-dataPath]").length&&f.push(b)});return $(f)},h=function(){var a=$.uuid();$("body").append("<div id='ac-"+a+"' class='hidden ac-renderHelper'></div>");return $("#ac-"+a)[0]},k=function(c,b,g){g=g||d;var l=h();l.innerHTML=c;q(l,function(){var c=e(l);c.length&&c.each(r);l.innerHTML=
a.replaceVars($(l).html());c=a.getNodesWithShowWhen($(l));$(c).each(function(c,b){a.checkShowWhen(b)||$(this).remove()});a.trigger();c=$(l).html();return g(c)})},n=function(b,f){f=f||d;var g=$(b).attr(c+"-dataSource"),l=$(b).attr(c+"-fragment");void 0!==l&&a.fragments.get(l,function(l,d){if(l)return f(l);g?a.API.call(g,$(b).attr(c+"-post"),function(c,g){a.appDataOP.setContext(g);a.appDataOP.setCurrent(g);k(d,g,function(a){b.innerHTML=a;f()})}):k(d,null,function(a){b.innerHTML=a;return f()})})};AC.loadFragment=
n;var q=function(b,f){f=f||d;var g=$("*["+c+"-fragment]",b);if(0===g.length)return f();var l=g.length,e=function(){0===--l&&f()};g.each(function(c,b){if(a.checkCondition(b))n(b,e);else return e()})},w=function(a){var f=e($("*["+c+"-dataPath]",a)),g={};f.replaceWith(function(a,c){var d=b();g[d]=f[a];return"$$"+d+"$$"});return g},r=function(b,f){var g=w(f),d=a.appDataOP.execute(a.rmMustashes($(f).attr(c+"-dataPath"))),v=f.innerHTML.replace(/ ac-dataPath=".*"/ig,"").trim(),m=a.appDataOP.current;f.innerHTML=
"";d.forEach(function(b){a.appDataOP.setCurrent(b);b=$($.parseHTML(a.replaceVars("<temp>"+v+"</temp>").replace(/\$\$(.*)\$\$/,function(a){return g[a.slice(2,-2)]})));var d=a.getNodesWithShowWhen(b);d.length&&d.each(function(b,d){a.checkShowWhen(d)?$(this).removeAttr(c+"-showWhen"):$(this).remove()});d=e(b);d.length&&d.each(r);$(f).append(b.children())});$(f).removeAttr(c+"-dataPath");a.appDataOP.setCurrent(m)};$("html").attr("lang");$.ajax({url:"/locale/"+$("html").attr("lang")+".json",success:function(c){a.appData.locale=
c},error:function(a,c,b,d){},dataType:"json",async:!1});var u=function(){var a=jQuery.Event("beforehashchange");$(document).trigger(a);if(!a.isDefaultPrevented()){var b=locationHash.get();$.isEmptyObject(b)&&n($("body>div")[0]);$.each(b,function(a,d){if(-1===a.indexOf("_ds")){$("#"+a).attr(c+"-fragment",b[a]).attr(c+"-dataSource",b[a+"_ds"]);var e=$("#"+a).parents(".modal");("127.0.0.1"===window.location.hostname||"localhost"===window.location.hostname||e&&$(e).is(":visible"))&&e.modal();n($("#"+
a)[0])}})}};window.onhashchange=function(){locationHash.hashChangeSource||(u(),a.trigger());locationHash.hashChangeSource=null};window.onload=function(){q($("body"),function(){u()})};$("body").on("click","a,  button",function(b){locationHash.hashChangeSource="internal";if($(b.currentTarget).attr(c+"-target")){var d=$(b.currentTarget).attr("href");if(d&&"#"===d[0])b.preventDefault();else{b.preventDefault();var g=jQuery.Event("beforehashchange");$(document).trigger(g);if(!g.isDefaultPrevented()){var e=
$(b.currentTarget);targetSelector=e.attr(c+"-target");d=e.attr("href");currFragment=$(targetSelector).attr(c+"-fragment");condition=a.rmMustashes(e.attr(c+"-condition"));e.parents(".nav").find("*[ac-target="+targetSelector+"].active").removeClass("active");e.addClass("active");new Spinner(e);if(!condition||a.appDataOP.execute(condition)){"/"===d[0]&&(d=d.slice(1));var h=$(targetSelector);h[0]&&(h.attr(c+"-fragment",d),h.attr(c+"-dataSource",e.attr(c+"-dataSource")||""),n(h[0],function(b){if(b)e.spinner.error("ERROR: "+
b.message);else if(a.trigger(),e.spinner.success(),b=e.attr(c+"-redirect"))window.location=b;else{b=targetSelector.slice(1);var g={};g[b]=d;var t=h.attr(c+"-dataSource");t&&(g[b+"_ds"]=t);locationHash.update(g)}}))}}}}});$.onAvailable("form",function(){this.attr("method","POST");this.attr("enctype","multipart/form-data")});$("body").on("submit","form",function(b){b.preventDefault();var d=jQuery.Event("beforehashchange");$(document).trigger(d);if(!d.isDefaultPrevented()){locationHash.hashChangeSource=
"internal";var e=$(this),h=e.attr(c+"-target"),k=e.attr("href");$(h).attr(c+"-fragment");var d=a.rmMustashes(e.attr(c+"-condition")),m=$(b.originalEvent.explicitOriginalTarget);m[0]||(m=e.find("[type=submit]"));new Spinner(m);if(!h)$.ajax({url:a.API.fixURL(e.attr("action")),data:e.serialize(),success:function(a){var b=!1,d;for(d in a)if("error"===a[d]["@status"]){b=a[d]["@message"]||a[d]["@error"];(a=m.parents("form").find(".ac-error."+a[d]["@error"]))&&a.addClass("show");break}if(b)m.spinner.error(b);
else if(m.spinner.success(),b=e.attr(c+"-redirect"))window.location=b},error:function(a,c,b){try{m.spinner.error(a.responseJSON.GlobalError.message)}catch(d){m.spinner.error(b||"Server not responding.")}},type:"POST"});else if(!d||a.appDataOP.execute(d)){"/"===k[0]&&(k=k.slice(1));var p=$(h);p[0]&&(p.attr(c+"-fragment",k),(b=e.attr(c+"-dataSource"))?p.attr(c+"-dataSource",b):p.attr(c+"-dataSource",null),$.ajax({url:a.API.fixURL(e.attr("action")),data:e.serialize(),success:function(b){var d=!1;if("error"===
b.status){var d=b.message||b.error,f=m.parents("form").find(".ac-error."+b.error);f&&(f.addClass("show"),f.parent("div").addClass("has-error"))}d?m.spinner.error(d):(m.spinner.success(),(d=e.attr(c+"-redirect"))?window.location=d:(a.appDataOP.setContext(b),n(p[0],function(b){a.trigger();b=h.slice(1);var d={};d[b]=k;d[b+"_ds"]=e.attr(c+"-dataSource");locationHash.update(d)})))},error:function(a,b,c){try{m.spinner.error(a.responseJSON.GlobalError.message)}catch(d){m.spinner.error(c||"Server not responding.")}},
type:"POST"}))}}})});
